---
title: "homework_3"
format: html
editor: visual
---

```{r}
## reading in packages

# general use
library(tidyverse)
library(readxl)
library(here)
library(janitor)

# visualizing pairs
library(GGally)

# model selection
library(MuMIn)

# model predictions
library(ggeffects)

# model tables
library(gtsummary)
library(flextable)
library(modelsummary)

drought_exp <- read_xlsx(path = here("data", 
                                     "Valliere_etal_EcoApps_Data.xlsx"),
                         sheet = "First Harvest")

# quick look at data 
str(drought_exp)
class(drought_exp)
```

```{r}
# cleaning
drought_exp_clean <- drought_exp %>% 
  clean_names() %>% # nicer column names
  mutate(species_name = case_when( # adding column with species scientific names
    species == "ENCCAL" ~ "Encelia californica", # bush sunflower
    species == "ESCCAL" ~ "Eschscholzia californica", # California poppy
    species == "PENCEN" ~ "Penstemon centranthifolius", # Scarlet bugler
    species == "GRICAM" ~ "Grindelia camporum", # great valley gumweed
    species == "SALLEU" ~ "Salvia leucophylla", # Purple sage
    species == "STIPUL" ~ "Nasella pulchra", # Purple needlegrass
    species == "LOTSCO" ~ "Acmispon glaber" # deerweed
  )) %>% 
  relocate(species_name, .after = species) %>% # moving species_name column after species
  mutate(water_treatment = case_when( # adding column with full treatment names
    water == "WW" ~ "Well watered",
    water == "DS" ~ "Drought stressed"
  )) %>% 
  relocate(water_treatment, .after = water) # moving water_treatment column after water
```

```{r}
#visualizing and making correlation for background info
ggpairs(drought_exp_clean, # data frame
        columns = c("leaf_dry_weight_g", # columns to visualize
                    "sla", 
                    "shoot_g", 
                    "root_g", 
                    "total_g"), 
        upper = list(method = "pearson")) + # calculating Pearson correlation coefficient
  theme_bw() + # cleaner theme
  theme(panel.grid = element_blank()) # getting rid of gridlines

```

### how does total biomass differ between species?

```{r}
ggplot(data = drought_exp_clean, # data frame
       aes(x = reorder(species_name, # reordering x-axis
                       -total_g, # in reverse order of mean total mass
                       fun = mean), # calculating mean to reorder
           y = total_g)) + # y-axis
  geom_jitter(width = 0.1, # narrow jitter
              height = 0) # not jittering points up and down
```

**Plants with larger biomass seem to have larger ranges. Grindelia has highest biomass and Acrispon has lowest biomass.**

### how does total biomass differ between water treatments?

```{r}
ggplot(data = drought_exp_clean, # data frame
       aes(x = water_treatment, # x-axis
           y = total_g)) + # y-axis
  geom_jitter(width = 0.1, # narrow jitter
              height = 0) # not jittering points up and down
```

**The total biomass is lower in the drought stressed water treatment compared to the well watered treatment. Well watered plants tend to have larger biomass. This makes sense based on how plants work.**

### how does specific leaf area (SLA) influence total biomass?

```{r}
ggplot(data = drought_exp_clean, # data frame
       aes(x = sla, # x-axis
           y = total_g)) + # y-axis
  geom_point() # scatterplot
```

**Specific leaf area doesn't really effect total biomass when looking visually but it is important to check correlation to compare visual and statistical.**

## 0. Null model

```{r}
model0 <- lm(total_g ~ 1, # formula
             data = drought_exp_clean) # data frame
```

## 1. total biomass as a function of SLA, water treatment, and species

```{r}
# saturated model
model1 <- lm(total_g ~ sla + water_treatment + species_name,
             data = drought_exp_clean)

par(mfrow = c(2, 2))
plot(model1)
```

## 2. total biomass as a function of SLA and water treatment

Diagnostics for saturated model look good.

```{r}
model2 <- lm(total_g ~ sla + water_treatment,
             data = drought_exp_clean)

plot(model2)
```

## 3. total biomass as a function of SLA and species

```{r}
model3 <- lm(total_g ~ sla + species_name,
             data = drought_exp_clean)

plot(model3)
```

## 4. my own model: total biomass as a function of water treatment and species

```{r}
model4 <- lm(total_g ~ water_treatment + species_name,
             data = drought_exp_clean)

plot(model4)
```

## Problem 1

## A) Table of all models

```{r}
# comparing models in table
modelsummary::modelsummary( # this function takes a list of models
  list( 
    "null" = model0, # "model name" = model object
    "model 1" = model1,
    "model 2" = model2,
    "model 3" = model3,
    "model 4" = model4))
```

```{r}
model.sel(model0,
          model1, 
          model2, 
          model3,
          model4)
```

## Caption:

Table 1: Models with Predictors. This table represents the models, in each row, with their respective predictors, in each column. The right side of the table includes the comparative statistics such as the AIC, delta, and weight values.

## B) Statistical Methods

To examine the influence of the species, water treatment, and specific leaf areas on the total biomass, I created five different models comparing these variables to determine which one best describes total biomass. To determine the model that best described total biomass, I compared all of the models in a table and found the one that conformed to assumptions of linear models and had an AIC value of 0 which was model 4. To evaluate linear model assumptions, I made visualizations of each model and analyzed the homoscedasticity, normality, and outliers.

## C) Visualization

```{r}

ggpredict(model1, 
                         terms = c("sla",
                                   "water_treatment", 
                                   "species_name"))
ggpredict(model2, 
                         terms = c("sla", 
                                   "water_treatment"))
ggpredict(model3, 
                         terms = c("sla", 
                                   "species_name"))
ggpredict(model4, 
                         terms = c("water_treatment", 
                                   "species_name"))
```

```{r}
# creating new data frame of model predictions for plotting
model_preds_for_plotting <- model_preds %>% 
  rename(sla = x, # renaming columns to make this easier to use
         water_treatment = group,
         species_name = facet)

# use View(model_preds_for_plotting) 
# to compare this to the original model_preds data frame

ggplot() +
  # underlying data
  geom_point(data = drought_exp_clean,
             aes(x = sla,
                 y = total_g,
                 color = water_treatment)) +
  # model prediction 95% CI ribbon
  geom_ribbon(data = model_preds_for_plotting,
              aes(x = sla, 
                  y = predicted,
                  ymin = conf.low,
                  ymax = conf.high,
                  fill = water_treatment),
              alpha = 0.2) +
  # model prediction lines
  geom_line(data = model_preds_for_plotting,
            aes(x = sla, 
                y = predicted,
                color = water_treatment)) +
  # cleaner theme
  theme_classic() +
  # creating different panels for species
  facet_wrap(~species_name) 
```

## Caption:

## E) Results
